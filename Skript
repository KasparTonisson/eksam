# Import Active Directory module
Import-Module ActiveDirectory

# Path to the CSV file
$csvPath = "C:\Users\Administrator\Downloads\kasutajad.csv"

# Check if the CSV file exists
if (-Not (Test-Path -Path $csvPath)) {
    Write-Host "CSV file not found at path $csvPath"
    exit
}

# Import CSV file with skipping the header row
$users = Import-Csv -Path $csvPath -Header 'Eesnimi', 'Perekonnanimi', 'Osakond'

# Iterate over each user in the CSV
foreach ($user in $users) {
    # Extract user properties
    $firstName = $user.Eesnimi
    $lastName = $user.Perekonnanimi -replace ";", " "  # Replace comma with space
    $department = $user.Osakond
    $username = "$($firstName).$($lastName)"
    $password = "Passw0rd"  # This should be securely generated and managed
    $ou = "OU=$department,DC=oige,DC=ee"

    # Create a hashtable for the user properties
    $userProps = @{
        SamAccountName = $username
        UserPrincipalName = "$username@oige.ee"
        GivenName = $firstName
        Surname = $lastName
        Name = "$firstName $lastName"
        DisplayName = "$firstName $lastName"
        Path = $ou
        AccountPassword = (ConvertTo-SecureString $password -AsPlainText -Force)
        Enabled = $true
    }

    # Create the user in Active Directory
    try {
        New-ADUser @userProps
        Write-Host "User $username created successfully in $ou"
    } catch {
        Write-Host "Failed to create user $username: $_"
    }
}
