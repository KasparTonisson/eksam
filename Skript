# Impordi vajalikud moodulid
Import-Module ActiveDirectory

# Seaded serveri ja OU väärtused
$Server = "ldap.oige.ee"

# Loe sisendfail
$users = Import-Csv "kasutajad.csv"

# Loo tühi loend OU-de jaoks
$createdOUs = @()

# Loo ühendus Active Directory serveriga
$connection = Connect-ADComputer -Server $Server

# Itera kõikide kasutajate kohta failis
foreach ($user in $users) {
    # Välja võtmine kasutaja info
    $FirstName = $user.Eesnimi
    $LastName = $user.Perekonnanimi
    $Department = $user.Osakond

    # Lisa OU loendisse, kui unikaalne
    if (!$createdOUs.Contains($Department)) {
        $createdOUs += $Department

        # Loo OU, kui see pole olemas
        $ouPath = "OU=$Department"
        New-ADOrganizationalUnit -Name $Department -Path $ouPath -ErrorAction SilentlyContinue
    }

    # Kasutaja DN moodustamine vastavas OU-s
    $userDn = "CN=$FirstName $LastName,$ouPath"

    # Kasutaja objekti loomine
    $userObject = New-Object PSObject -Property @{
        name = "$FirstName $LastName"
        samAccountName = "$($FirstName[0]).$($LastName)"
        surname = $LastName
        givenName = $FirstName
        department = $Department
        # Seadista vaikimisi salasõna (asenda tegelikku parooliga)
        accountPassword = ConvertTo-SecureString("salajaneParool" -AsPlainText -Force
    }

    # Lisa kasutaja vastavasse OU-sse
    New-ADUser -Instance $userObject -ErrorAction SilentlyContinue
}

# Lõpeta ühendus Active Directory serveriga
Disconnect-ADComputer $connection

# Prindi loodud OU-de loend
Write-Host "Loodud OU-d:"
foreach ($ou in $createdOUs) {
    Write-Host $ou
}
